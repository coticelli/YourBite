<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YourBite - Login</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Header Section -->
    <div class="header">
        <!-- Logo -->
        <img src="img/logo.png" alt="YourBite Logo" class="logo">
    </div>

    <!-- Main Content -->
    <div class="content">
        <div>
            <button class="tab active"><a href="login.html" style="text-decoration:none; color: black;">Log
                    in</a></button>
            <button class="tab"><a href="signup.html" style="text-decoration:none; color: black;">Sign
                    Up</a></button><br><br>
        </div>
        <div class="welcome-message"><br>
            Welcome to YourBite
        </div>

        <!-- Log In Form -->
        <form id="loginForm" class="form">
            <div class="form-group">
                <input type="email" id="email" placeholder=" " required autocomplete="email">
                <label for="email">E-mail</label>
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder=" " required autocomplete="current-password">
                <label for="password">Password</label>
            </div>
            <!-- Log In Button inside the same form box -->
            <button type="submit" class="primary-btn">Log In</button><br>
            <button id="googleLoginBtn" class="btn btn-primary">
                <i class="fab fa-google"></i> Accedi con Google
            </button>

            <!-- Forgot Password Link -->
            <div class="forgot-password">
                <a href="#">Forgot Password?</a>
            </div>
        </form>

        <!-- Message Div for errors -->
        <div id="message" style="color: red; font-size: 16px;"></div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Log per vedere i dati prima di inviarli al server
            console.log('Email:', email, 'Password:', password);

            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password }),
                credentials: 'include' // Importante per mantenere i cookie di sessione
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Risposta dal server:', data);

                    if (data.error) {
                        document.getElementById('message').innerText = data.error;
                    } else {
                        // Salva i dati utente nel localStorage
                        localStorage.setItem('username', data.username);
                        localStorage.setItem('userType', data.tipo || ''); // Usa 'tipo' come nelle risposte del server

                        // Salva un flag per indicare che l'utente è autenticato
                        localStorage.setItem('isAuthenticated', 'true');

                        // Verifica se redirectUrl è presente e corretta
                        if (data.redirectUrl && data.redirectUrl.trim() !== "") {
                            console.log('Redirecting to:', data.redirectUrl);
                            // Piccolo ritardo prima del reindirizzamento per dare tempo alla sessione di essere salvata
                            setTimeout(() => {
                                window.location.href = data.redirectUrl;
                            }, 100);
                        } else {
                            console.error('Redirect URL is not defined or empty');
                            document.getElementById('message').innerText = 'Errore durante il login. Riprova.';
                        }
                    }
                })
                .catch(error => {
                    console.error('Errore durante il login:', error);
                    document.getElementById('message').innerText = 'Errore durante il login. Riprova.';
                });
            console.log('Dati completi:', data);
        });
        document.getElementById('googleLoginBtn').addEventListener('click', function() {
    window.location.href = '/auth/google';
});
    </script>
</body>

</html>