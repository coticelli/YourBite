<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Assistenza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .message-list {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
        }
        .user-message {
            background-color: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
            max-width: 80%;
        }
        .system-message {
            background-color: #f1f1f1;
            text-align: center;
            max-width: 100%;
        }
        .other-message {
            background-color: #f1f1f1;
            align-self: flex-start;
            max-width: 80%;
        }
        .timestamp {
            font-size: 0.7rem;
            color: #777;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container mt-5 chat-container">
        <h2 class="text-center mb-4">Chat con Assistenza</h2>
        <div class="message-list d-flex flex-column" id="messageList"></div>
        <div id="typingIndicator" class="mb-2 text-muted" style="display: none;">
            L'operatore sta scrivendo...
        </div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="messageInput" placeholder="Scrivi un messaggio...">
            <button class="btn btn-primary" id="sendButton">Invia</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Recupera i dati utente dalla sessione (questo valore sarà disponibile nella pagina se l'utente è loggato)
        let userData = {
            userId: sessionStorage.getItem('userId') || "guest_" + Date.now(),
            username: sessionStorage.getItem('username') || "Cliente"
        };
        
        // All'avvio della pagina, prova a recuperare queste informazioni dal server se disponibili
        fetch('/api/user/info', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    userData = {
                        userId: data.user.id,
                        username: data.user.username
                    };
                    sessionStorage.setItem('userId', userData.userId);
                    sessionStorage.setItem('username', userData.username);
                }
                initializeChat();
            })
            .catch(err => {
                console.log('Utilizzando i dati utente di default', err);
                initializeChat();
            })
            .catch(err => {
                console.log('Utilizzando i dati utente di default', err);
                initializeChat();
            });
        
        function initializeChat() {
            const socket = io();
            const messageList = document.getElementById('messageList');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Connessione al socket
            socket.on('connect', () => {
                console.log('Connesso al server WebSocket');
                
                // Invia informazioni utente al server
                socket.emit('userJoin', userData);
                
                // Aggiunge un messaggio di sistema all'interfaccia
                addSystemMessage('Connesso all\'assistenza. Un operatore si unirà a breve.');
            });
            
            // Gestione della ricezione dei messaggi
            socket.on('message', (message) => {
                addMessage(message);
            });
            
            // Gestione dell'indicatore di digitazione
            socket.on('typing', (data) => {
                if (data.isTyping && data.userId !== userData.userId) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
            
            // Gestione connessione operatore
            socket.on('operatorJoin', (data) => {
                addSystemMessage(`L'operatore ${data.username} si è unito alla chat`);
            });
            
            // Gestione disconnessione operatore
            socket.on('operatorLeave', (data) => {
                addSystemMessage(`L'operatore ${data.username} ha lasciato la chat`);
            });
            
            // Gestione errori di connessione
            socket.on('connect_error', (error) => {
                console.error('Errore di connessione:', error);
                addSystemMessage('Errore di connessione al server. Riprova più tardi.');
            });
            
            // Evento invio messaggio
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                // Invia notifica che l'utente sta scrivendo
                socket.emit('typing', { isTyping: true });
                
                // Se viene premuto Invio, invia il messaggio
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Interrompe l'indicatore di digitazione quando l'utente smette di scrivere
            messageInput.addEventListener('blur', () => {
                socket.emit('typing', { isTyping: false });
            });
            
            function sendMessage() {
                const content = messageInput.value.trim();
                if (content) {
                    // Crea oggetto messaggio
                    const message = {
                        content: content,
                        sender: userData.userId,
                        senderName: userData.username,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Invia messaggio al server
                    socket.emit('message', message);
                    
                    // Pulisce il campo di input
                    messageInput.value = '';
                    
                    // Resetta l'indicatore di digitazione
                    socket.emit('typing', { isTyping: false });
                }
            }
            
            function addMessage(message) {
                const messageElement = document.createElement('div');
                const isCurrentUser = message.sender === userData.userId;
                
                messageElement.classList.add('message', 'd-flex');
                if (isCurrentUser) {
                    messageElement.classList.add('user-message', 'justify-content-end');
                } else {
                    messageElement.classList.add('other-message');
                }
                
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                messageElement.innerHTML = `
                    <div>
                        <div class="message-content">
                            ${isCurrentUser ? '' : `<strong>${message.senderName}</strong><br>`}
                            ${message.content}
                        </div>
                        <div class="timestamp">${time}</div>
                    </div>
                `;
                
                messageList.appendChild(messageElement);
                scrollToBottom();
            }
            
            function addSystemMessage(text) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'system-message', 'align-self-center');
                
                messageElement.innerHTML = `
                    <div>
                        <div class="message-content">${text}</div>
                        <div class="timestamp">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                
                messageList.appendChild(messageElement);
                scrollToBottom();
            }
            
            function scrollToBottom() {
                messageList.scrollTop = messageList.scrollHeight;
            }
            
            // Recupera cronologia messaggi precedenti
            fetch('/api/chat/history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId: userData.userId }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    // Aggiunge messaggi precedenti all'interfaccia
                    data.messages.forEach(message => {
                        addMessage(message);
                    });
                    addSystemMessage('Messaggi precedenti caricati');
                }
            })
            .catch(err => {
                console.error('Errore nel caricamento della cronologia:', err);
            });
        }
    </script>
</body>
</html>